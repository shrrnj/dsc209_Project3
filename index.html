<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Exploratory D3 Charts — Guttmacher (Excel source)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!-- D3 + SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;color:#111;}
  header{padding:16px 20px;border-bottom:1px solid #e5e7eb;}
  h1{margin:0;font-size:18px;}
  .wrap{padding:16px;display:grid;gap:16px;grid-template-columns:1fr;}
  @media(min-width:1100px){.wrap{grid-template-columns:1fr 1fr;}}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff;}
  .title{font-weight:600;margin:4px 0 10px;}
  svg{width:100%;height:auto;display:block;}
  .axis text{font-size:11px;}
  .axis path,.axis line{stroke:#9ca3af;}
  .bar{shape-rendering:crispEdges;}
  .dot{opacity:.9;stroke:#fff;}
  .tooltip{position:fixed;pointer-events:none;background:#111827;color:#fff;padding:8px 10px;border-radius:8px;
           font-size:12px;box-shadow:0 6px 18px rgba(0,0,0,.15);transform:translate(-50%,-120%);z-index:10;opacity:0;}
</style>
</head>
<body>
<header>
  <h1>Exploratory D3 Charts — Guttmacher (Excel source)</h1>
</header>

<div class="wrap">
  <div class="card"><div class="title">1) Top 10 States by Number of Clinics (2020)</div><svg id="c1" viewBox="0 0 700 420"></svg></div>
  <div class="card"><div class="title">2) Distribution of Abortion Rate (per 1,000, residence, 2020)</div><svg id="c2" viewBox="0 0 700 420"></svg></div>
  <div class="card"><div class="title">3) Clinics vs Abortions by Occurrence (2020)</div><svg id="c3" viewBox="0 0 700 480"></svg></div>
  <div class="card"><div class="title">4) % Counties w/o Clinic vs % Residents Traveling Out-of-State (2020)</div><svg id="c4" viewBox="0 0 700 480"></svg></div>
  <div class="card"><div class="title">5) Abortion Rate by Clinic Availability (Low vs High, median split)</div><svg id="c5" viewBox="0 0 700 480"></svg></div>
  <div class="card"><div class="title">6) Top 10 States by % Traveling Out-of-State (2020)</div><svg id="c6" viewBox="0 0 700 420"></svg></div>
</div>

<div id="tt" class="tooltip"></div>

<script>
// ----------- CONFIG -----------
const XLSX_PATH = "data/GuttmacherInstituteAbortionDataByState.xlsx";
const SHEET_NAME = "Guttmacher";

// Map original Excel headers -> short keys we’ll use in charts
const COLS = {
  state: "U.S. State",
  clinics_2020: "No. of abortion clinics, 2020",
  rate_res_2020: "No. of abortions per 1,000 women aged 15–44, by state of residence, 2020",
  abort_occ_2020: "No. of abortions, by state of occurrence, 2020",
  pct_travel_2020: "% of residents obtaining abortions who traveled out of state for care, 2020",
  pct_no_clinic_2020: "% of counties without a known clinic, 2020"
};

// Clean a cell that should be numeric: strip commas, %, dashes, 'unavailable'
function toNumber(v){
  if (v === null || v === undefined) return undefined;
  v = String(v).trim()
    .replace(/,/g,"")
    .replace(/%/g,"")
    .replace(/[—–]/g,"") // em/en dash
    .replace(/†/g,"");
  if (v === "" || v.toLowerCase() === "unavailable") return undefined;
  const num = +v;
  return Number.isFinite(num) ? num : undefined;
}

// Linear regression for simple trend lines
function linearFit(points){
  const n = points.length;
  const sx = d3.sum(points, d=>d.x);
  const sy = d3.sum(points, d=>d.y);
  const sxx = d3.sum(points, d=>d.x*d.x);
  const sxy = d3.sum(points, d=>d.x*d.y);
  const denom = n*sxx - sx*sx;
  if (!denom) return {m:0, b:d3.mean(points, d=>d.y)};
  const m = (n*sxy - sx*sy) / denom;
  const b = (sy - m*sx) / n;
  return {m, b};
}

const tt = d3.select("#tt");
const showTT = (html, [x,y]) => tt.style("opacity", 1).html(html).style("left", x+"px").style("top", y+"px");
const hideTT = () => tt.style("opacity", 0);

// ----------- Load Excel, parse & clean, then draw -----------
fetch(XLSX_PATH)
  .then(r => r.arrayBuffer())
  .then(buf => {
    const wb = XLSX.read(buf, {type: "array"});
    const ws = wb.Sheets[SHEET_NAME];
    const rows = XLSX.utils.sheet_to_json(ws, {defval: null}); // array of objects

    // Rename/clean to a tidy array with our keys
    const data = rows.map(r => ({
      state: r[COLS.state],
      clinics_2020: toNumber(r[COLS.clinics_2020]),
      rate_res_2020: toNumber(r[COLS.rate_res_2020]),
      abort_occ_2020: toNumber(r[COLS.abort_occ_2020]),
      pct_travel_2020: toNumber(r[COLS.pct_travel_2020]),
      pct_no_clinic_2020: toNumber(r[COLS.pct_no_clinic_2020]),
    })).filter(d => d.state && d.state !== "");

    drawAll(data);
  });

function drawAll(data){
  chart1_topClinicsBar(data);
  chart2_rateHist(data);
  chart3_scatterClinicsVsOccurrence(data);
  chart4_scatterNoClinicVsTravel(data);
  chart5_boxByClinicAvailability(data);
  chart6_topTravelBar(data);
}

// ----------- Chart 1: Top 10 clinics (barh) -----------
function chart1_topClinicsBar(data){
  const svg = d3.select("#c1");
  const m = {t:20,r:20,b:30,l:170}, w=700-m.l-m.r, h=420-m.t-m.b;
  const g = svg.append("g").attr("transform",`translate(${m.l},${m.t})`);

  const rows = data.filter(d=>Number.isFinite(d.clinics_2020))
    .sort((a,b)=>d3.descending(a.clinics_2020,b.clinics_2020))
    .slice(0,10)
    .reverse();

  const y = d3.scaleBand().domain(rows.map(d=>d.state)).range([h,0]).padding(0.12);
  const x = d3.scaleLinear().domain([0, d3.max(rows,d=>d.clinics_2020)]).nice().range([0,w]);

  g.selectAll(".bar").data(rows).join("rect")
    .attr("class","bar")
    .attr("x",0).attr("y",d=>y(d.state))
    .attr("width",d=>x(d.clinics_2020)).attr("height",y.bandwidth())
    .attr("fill","#60a5fa")
    .on("mousemove",(ev,d)=> showTT(`<strong>${d.state}</strong><br/>Clinics: ${d3.format(",")(d.clinics_2020)}`, d3.pointer(ev)))
    .on("mouseleave", hideTT);

  g.append("g").attr("class","axis").call(d3.axisLeft(y));
  g.append("g").attr("class","axis").attr("transform",`translate(0,${h})`).call(d3.axisBottom(x).ticks(6).tickFormat(d3.format(",")));
}

// ----------- Chart 2: Histogram of abortion rate -----------
function chart2_rateHist(data){
  const svg = d3.select("#c2");
  const m = {t:20,r:20,b:40,l:50}, w=700-m.l-m.r, h=420-m.t-m.b;
  const g = svg.append("g").attr("transform",`translate(${m.l},${m.t})`);

  const vals = data.map(d=>d.rate_res_2020).filter(Number.isFinite);
  const x = d3.scaleLinear().domain(d3.extent(vals)).nice().range([0,w]);
  const bins = d3.bin().domain(x.domain()).thresholds(15)(vals);
  const y = d3.scaleLinear().domain([0, d3.max(bins, d=>d.length)]).nice().range([h,0]);

  g.selectAll("rect").data(bins).join("rect")
    .attr("x", d=>x(d.x0)+1)
    .attr("y", d=>y(d.length))
    .attr("width", d=>Math.max(0, x(d.x1)-x(d.x0)-1))
    .attr("height", d=>h - y(d.length))
    .attr("fill","#86efac")
    .on("mousemove",(ev,d)=> showTT(`Range: ${d3.format(".1f")(d.x0)}–${d3.format(".1f")(d.x1)}<br/>States: ${d.length}`, d3.pointer(ev)))
    .on("mouseleave", hideTT);

  g.append("g").attr("class","axis").attr("transform",`translate(0,${h})`).call(d3.axisBottom(x).ticks(6));
  g.append("g").attr("class","axis").call(d3.axisLeft(y).ticks(6));
  g.append("text").attr("x", w/2).attr("y", h+34).attr("text-anchor","middle")
    .text("Abortion rate per 1,000 (residence, 2020)");
}

// ----------- Chart 3: Clinics vs occurrence (scatter + trend) -----------
function chart3_scatterClinicsVsOccurrence(data){
  const svg = d3.select("#c3");
  const m = {t:20,r:20,b:44,l:56}, w=700-m.l-m.r, h=480-m.t-m.b;
  const g = svg.append("g").attr("transform",`translate(${m.l},${m.t})`);

  const rows = data.filter(d=>Number.isFinite(d.clinics_2020) && Number.isFinite(d.abort_occ_2020));
  const x = d3.scaleLinear().domain(d3.extent(rows, d=>d.clinics_2020)).nice().range([0,w]);
  const y = d3.scaleLinear().domain(d3.extent(rows, d=>d.abort_occ_2020)).nice().range([h,0]);

  g.append("g").attr("class","axis").attr("transform",`translate(0,${h})`).call(d3.axisBottom(x).ticks(6).tickFormat(d3.format(",")));
  g.append("g").attr("class","axis").call(d3.axisLeft(y).ticks(6));

  g.selectAll(".dot").data(rows).join("circle")
    .attr("class","dot").attr("r",4.5)
    .attr("cx", d=>x(d.clinics_2020)).attr("cy", d=>y(d.abort_occ_2020))
    .attr("fill","#60a5fa")
    .on("mousemove",(ev,d)=> showTT(`<strong>${d.state}</strong><br/>Clinics: ${d3.format(",")(d.clinics_2020)}<br/>Abortions (occurrence): ${d3.format(",")(d.abort_occ_2020)}`, d3.pointer(ev)))
    .on("mouseleave", hideTT);

  const pts = rows.map(d=>({x:d.clinics_2020, y:d.abort_occ_2020}));
  const {m: slope, b: intercept} = linearFit(pts);
  const x0 = x.domain()[0], x1 = x.domain()[1];
  g.append("line")
    .attr("x1", x(x0)).attr("y1", y(slope*x0 + intercept))
    .attr("x2", x(x1)).attr("y2", y(slope*x1 + intercept))
    .attr("stroke","#111").attr("stroke-width",1.2).attr("stroke-dasharray","4,3");
}

// ----------- Chart 4: % no clinic vs % travel (scatter + trend) -----------
function chart4_scatterNoClinicVsTravel(data){
  const svg = d3.select("#c4");
  const m = {t:20,r:20,b:44,l:56}, w=700-m.l-m.r, h=480-m.t-m.b;
  const g = svg.append("g").attr("transform",`translate(${m.l},${m.t})`);

  const rows = data.filter(d=>Number.isFinite(d.pct_no_clinic_2020) && Number.isFinite(d.pct_travel_2020));
  const x = d3.scaleLinear().domain(d3.extent(rows,d=>d.pct_no_clinic_2020)).nice().range([0,w]);
  const y = d3.scaleLinear().domain(d3.extent(rows,d=>d.pct_travel_2020)).nice().range([h,0]);

  g.append("g").attr("class","axis").attr("transform",`translate(0,${h})`).call(d3.axisBottom(x).ticks(6));
  g.append("g").attr("class","axis").call(d3.axisLeft(y).ticks(6));

  g.selectAll(".dot").data(rows).join("circle")
    .attr("class","dot").attr("r",4.5)
    .attr("cx", d=>x(d.pct_no_clinic_2020)).attr("cy", d=>y(d.pct_travel_2020))
    .attr("fill","#86efac")
    .on("mousemove",(ev,d)=> showTT(`<strong>${d.state}</strong><br/>% counties w/o clinic: ${d3.format(".0f")(d.pct_no_clinic_2020)}%<br/>% traveling: ${d3.format(".1f")(d.pct_travel_2020)}%`, d3.pointer(ev)))
    .on("mouseleave", hideTT);

  const pts = rows.map(d=>({x:d.pct_no_clinic_2020, y:d.pct_travel_2020}));
  const {m: slope, b: intercept} = linearFit(pts);
  const x0 = x.domain()[0], x1 = x.domain()[1];
  g.append("line")
    .attr("x1", x(x0)).attr("y1", y(slope*x0 + intercept))
    .attr("x2", x(x1)).attr("y2", y(slope*x1 + intercept))
    .attr("stroke","#111").attr("stroke-width",1.2).attr("stroke-dasharray","4,3");
}

// ----------- Chart 5: Boxplot by clinic availability (median split) -----------
function chart5_boxByClinicAvailability(data){
  const svg = d3.select("#c5");
  const m = {t:20,r:20,b:40,l:56}, w=700-m.l-m.r, h=480-m.t-m.b;
  const g = svg.append("g").attr("transform",`translate(${m.l},${m.t})`);

  const rows = data.filter(d=>Number.isFinite(d.clinics_2020) && Number.isFinite(d.rate_res_2020));
  const med = d3.median(rows, d=>d.clinics_2020);
  const group = rows.map(d => ({grp: d.clinics_2020 >= med ? "High clinics" : "Low clinics", val: d.rate_res_2020, state: d.state}));

  function fiveNum(arr){
    const s = arr.slice().sort(d3.ascending);
    return {
      min: d3.min(s),
      q1: d3.quantileSorted(s, 0.25),
      med: d3.quantileSorted(s, 0.50),
      q3: d3.quantileSorted(s, 0.75),
      max: d3.max(s)
    };
  }

  const groups = ["Low clinics","High clinics"];
  const stats = groups.map(name => {
    const vals = group.filter(d=>d.grp===name).map(d=>d.val).filter(Number.isFinite);
    return {name, vals, ...fiveNum(vals)};
  });

  const x = d3.scaleBand().domain(groups).range([0,w]).padding(0.4);
  const y = d3.scaleLinear().domain([0, d3.max(group, d=>d.val)]).nice().range([h,0]);

  g.append("g").attr("class","axis").attr("transform",`translate(0,${h})`).call(d3.axisBottom(x));
  g.append("g").attr("class","axis").call(d3.axisLeft(y));

  const boxW = x.bandwidth();
  const boxes = g.selectAll(".box").data(stats).join("g").attr("transform", d=>`translate(${x(d.name)},0)`);

  boxes.append("rect")
    .attr("x", boxW*0.15).attr("width", boxW*0.7)
    .attr("y", d=>y(d.q3)).attr("height", d=>y(d.q1)-y(d.q3))
    .attr("fill","#fde68a").attr("stroke","#111");

  boxes.append("line")
    .attr("x1", boxW*0.15).attr("x2", boxW*0.85)
    .attr("y1", d=>y(d.med)).attr("y2", d=>y(d.med))
    .attr("stroke","#111").attr("stroke-width",1.5);

  boxes.append("line") // whisker min
    .attr("x1", boxW*0.5).attr("x2", boxW*0.5)
    .attr("y1", d=>y(d.min)).attr("y2", d=>y(d.q1))
    .attr("stroke","#111");
  boxes.append("line")
    .attr("x1", boxW*0.35).attr("x2", boxW*0.65)
    .attr("y1", d=>y(d.min)).attr("y2", d=>y(d.min))
    .attr("stroke","#111");

  boxes.append("line") // whisker max
    .attr("x1", boxW*0.5).attr("x2", boxW*0.5)
    .attr("y1", d=>y(d.q3)).attr("y2", d=>y(d.max))
    .attr("stroke","#111");
  boxes.append("line")
    .attr("x1", boxW*0.35).attr("x2", boxW*0.65)
    .attr("y1", d=>y(d.max)).attr("y2", d=>y(d.max))
    .attr("stroke","#111");

  // jittered points
  g.selectAll(".pt").data(group).join("circle")
    .attr("class","pt").attr("r",2.8)
    .attr("cx", d=> x(d.grp) + boxW/2 + (Math.random()-0.5)*boxW*0.5 )
    .attr("cy", d=> y(d.val))
    .attr("fill","#f59e0b")
    .on("mousemove",(ev,d)=> showTT(`<strong>${d.state}</strong><br/>Rate: ${d3.format(".1f")(d.val)}`, d3.pointer(ev)))
    .on("mouseleave", hideTT);
}

// ----------- Chart 6: Top 10 % traveling (barh) -----------
function chart6_topTravelBar(data){
  const svg = d3.select("#c6");
  const m = {t:20,r:20,b:30,l:170}, w=700-m.l-m.r, h=420-m.t-m.b;
  const g = svg.append("g").attr("transform",`translate(${m.l},${m.t})`);

  const rows = data.filter(d=>Number.isFinite(d.pct_travel_2020))
    .sort((a,b)=>d3.descending(a.pct_travel_2020, b.pct_travel_2020))
    .slice(0,10)
    .reverse();

  const y = d3.scaleBand().domain(rows.map(d=>d.state)).range([h,0]).padding(0.12);
  const x = d3.scaleLinear().domain([0, d3.max(rows, d=>d.pct_travel_2020)]).nice().range([0,w]);

  g.selectAll(".bar").data(rows).join("rect")
    .attr("class","bar")
    .attr("x",0).attr("y", d=>y(d.state))
    .attr("width", d=>x(d.pct_travel_2020)).attr("height", y.bandwidth())
    .attr("fill","#fca5a5")
    .on("mousemove",(ev,d)=> showTT(`<strong>${d.state}</strong><br/>% traveling: ${d3.format(".1f")(d.pct_travel_2020)}%`, d3.pointer(ev)))
    .on("mouseleave", hideTT);

  g.append("g").attr("class","axis").call(d3.axisLeft(y));
  g.append("g").attr("class","axis").attr("transform",`translate(0,${h})`).call(d3.axisBottom(x).ticks(6));
}
</script>
</body>
</html>